<html><head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=8,IE=9,IE=10">
<meta http-equiv="Expires" content="0"><meta http-equiv="Cache-Control" content="no-cache"><meta http-equiv="Cache-Control" content="no-store">
<script src="../static/jquery/jquery-1.8.3.min.js" type="text/javascript"></script>
<link href="../static/bootstrap/2.3.1/css_cerulean/bootstrap.min.css" type="text/css" rel="stylesheet">
<script src="../static/bootstrap/2.3.1/js/bootstrap.min.js" type="text/javascript"></script>
<link href="../static/bootstrap/2.3.1/awesome/font-awesome.min.css" type="text/css" rel="stylesheet">
<!--[if lte IE 7]><link href="../static/bootstrap/2.3.1/awesome/font-awesome-ie7.min.css" type="text/css" rel="stylesheet" /><![endif]-->
<script src="../static/bootstrap/bsie/js/bootstrap-ie.min.js" type="text/javascript"></script><![endif]-->
<script src="../static/media/js/main.js" type="text/javascript"></script>
<!-- <link href="../static/jquery-select2/4.0/select2.min.css" rel="stylesheet"> -->
<!-- <script src="../static/jquery-select2/4.0/select2.min.js" type="text/javascript"></script> -->
<script src="../static/jquery-select2/4.0/zh-CN.js" type="text/javascript"></script>
<link href="../static/jquery-validation/1.11.0/jquery.validate.min.css" type="text/css" rel="stylesheet">
<script src="../static/jquery-validation/1.11.0/jquery.validate.min.js" type="text/javascript"></script>
<link href="../static/jquery-jbox/2.3/Skins/Bootstrap/jbox.min.css" rel="stylesheet">
<script src="../static/jquery-jbox/2.3/jquery.jBox-2.3.min.js" type="text/javascript"></script>
<script src="../static/My97DatePicker/WdatePicker.js" type="text/javascript"></script><link href="../static/My97DatePicker/skin/WdatePicker.css" rel="stylesheet" type="text/css">
<script src="../static/common/mustache.min.js" type="text/javascript"></script>
<link href="../static/common/smart.min.css" type="text/css" rel="stylesheet">
<script src="../static/common/smart.min.js" type="text/javascript"></script>
<script src="../static/jquery-form/3.51.0/jquery.form.js" type="text/javascript"></script>
<link href="../static/media/css/my-style.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript">var ctx = '/admin', ctxStatic='/static';</script>
<script src="../../config/smart-common.js" type="text/javascript"></script>
<script src="../static/wy/area.js" type="text/javascript"></script>
<script src="../static/wy/type.js" type="text/javascript"></script>
<title>维修信息添加</title>
<meta name="decorator" content="default"/>

    <title>维修信息修改</title>
    <meta name="decorator" content="default">
 
</head>
<body>

<br>
<form id="inputForm" class="form-horizontal"  method="post" novalidate="novalidate">
    <input id="id" name="id" type="hidden" />
    <input id="orderNumber" name="orderNumber" type="hidden" />
    <input id="repairDetailAddress" name="repairDetailAddress" type="hidden" />
<script type="text/javascript">top.$.jBox.closeTip();</script>

    <div class="control-group">
        <label class="control-label">报修人:</label>
        <div class="controls">
           <input id="repairPeopleName" name="repairPeopleName" readonly="readonly" class="required" type="text" value="" maxlength="50">
           <input id="repairPeopleId" name="repairPeopleId"  type="text" value="" maxlength="50" style="display:none">
        	<span class="help-inline"><font color="red">*</font> </span>
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">报修电话:</label>
        <div class="controls">
            <input id="repairPhone" name="repairPhone" readonly="readonly" class="required"  type="text" value="" maxlength="50">
            <span class="help-inline"><font color="red">*</font> </span>
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">报修地址:</label>
        <div class="controls">
        		<select id="repairAddress1" style="width:88px;" class="input-mini" name="repairAddress1" tabindex="-1">
        			<option value=""></option>
        		</select>
    			<select id="repairAddress2" style="width:88px;" class="input-mini" name="repairAddress2" tabindex="-1">
    				<option value=""></option>
    			</select>
    			<select id="repairAddress3" style="width:88px;" class="input-mini" name="repairAddress3" tabindex="-1">
    				<option value=""></option>
    			</select>
    			
    			<input type=hidden id="repairAddress" name="repairAddress" />
    			<input type="hidden" id="repairAddressCode" name="repairAddressCode" />
       		<span class="help-inline"><font color="red">*</font> </span>
        </div>
    </div>
    <div class="control-group">
        <label class="control-label">详细地址:</label>
        <div class="controls">
            <input id="detailAddress" name="detailAddress" class="required" type="text" value="" maxlength="50">
      		<span class="help-inline"><font color="red">*</font> </span>
        </div>
    </div>
    <!-- <div class="control-group">
	        <label class="control-label">事件来源:</label>
	        <div class="controls">
		         <select id="incidentSource" name="incidentSource" class="input-xlarge select2-offscreen" tabindex="-1">
	            	<option value=""></option>
	            	<option value="pc端提报">pc端提报</option>
	            	<option value="app端提报">app端提报</option>
	            	<option value="检修转事件">检修转事件</option>
	             </select>
	        	<span class="help-inline"><font color="red">*</font> </span>
	        </div>
        </div> -->
       <div class="control-group">
	        <label class="control-label">事件级别:</label>
	        <div class="controls">
		         <select id="incidentRank" name="incidentRank" class="input-xlarge select2-offscreen" tabindex="-1">
	            	<option value=""></option>
	            	<option value="一般">一般</option>
	            	<option value="紧急">紧急</option>
	             </select>
	        	<span class="help-inline"><font color="red">*</font> </span>
	        </div>
        </div>
        <div class="control-group">
	        <label class="control-label">紧急事件分类:</label>
	        <div class="controls">
	        <select id="emergenciesType" name="emergenciesType" class="input-xlarge select2-offscreen" tabindex="-1">
	            	<option value=""></option>
	            	<option value="部长以上">部长以上</option>
	            	<option value="停电">停电</option>
	            	<option value="电梯故障">电梯故障</option>
	            	<option value="喷淋头喷水">喷淋头喷水</option>
	            	<option value="火灾">火灾</option>
	            	<option value="发水">发水</option>
	             </select>
	        	<span class="help-inline"><font color="red">*</font> </span>
	        </div>
        </div>
        <div class="control-group">
	        <label class="control-label">报修类型:</label>
	        <div class="controls">
	        	 <select id="repairType1" style="width:133px;" name="repairType1" class="input-mini" tabindex="-1">
	            	<option value=""></option>
	            	<!-- <option value="强电维修">强电维修</option>
	            	<option value="弱电维修">弱电维修</option>
	            	<option value="空调维修">空调维修</option>
	            	<option value="给排水维修">给排水维修</option>
	            	<option value="电梯维修">电梯维修</option>
	            	<option value="综合维修">综合维修</option> -->
	             </select>
	             <select id="repairType2" style="width:133px;" name="repairType2" class="input-mini" tabindex="-1">
	             </select>
	             <input id="repairType"  name="repairType" class="input-mini required" type="hidden" value="" maxlength="50">
	             <input id="repairTypeCode"  name="repairTypeCode" class="input-mini required" type="hidden" value="" maxlength="50">
	        	<span class="help-inline"><font color="red">*</font> </span>
	        </div>
        </div>
        <div class="control-group">
	        <label class="control-label">预约时间:</label>
	        <div class="controls">
	            <input id="appointmentTime" style="width:133px;" onclick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss',isShowClear:false})" name="appointmentTime" class="required Wdate" type="text" value="" maxlength="50">
	           
	            <input id="appointmentTimeGo" style="width:133px;" onclick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss',isShowClear:false})" name="appointmentTimeGo" class="required Wdate" type="text" value="" maxlength="50">
	        	<span class="help-inline"><font color="red">*</font> </span>
	        </div>
        </div>
        <div class="control-group">
	        <label class="control-label">报修设备:</label>
	        <div class="controls">
	            <input id="repairEquipment" name="repairEquipment" type="text" value="" maxlength="50">
	        	<input id="repairEquipmentIds" name="repairEquipmentIds" type="hidden" readonly="readonly" style="border: 0px;">
	        </div>
        </div>
        <div class="control-group">
	        <label class="control-label">故障描述:</label>
	        <div class="controls">
				<textarea id="faultDescription" name="faultDescription" rows="5" cols="40" style="width:270px;">
	        	</textarea>
	        	<span class="help-inline"><font color="red">*</font> </span>
	        </div>
        </div>
        <div class="control-group">
	        <label class="control-label">备注:</label>
	        <div class="controls">
				<input id="remark"  name="remark" class="required" type="text" value="" maxlength="50">
	        </div>
        </div>
    <div class="form-actions">
    	<input id="btnSubmit" class="btn btn-primary" type="submit" value="提  交">
    </div>
</form>
<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		 <div class="modal-header">
		    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		    <h4 id="myModalLabel">请确认报修信息</h4>
		 </div>
		<div class="modal-body">
	  		<iframe id="Iframe"></iframe>
	    </div>
</div>
<div id="myModals" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		 <div class="modal-header">
		    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		    <h4 id="myModalLabel">设备信息</h4>
		 </div>
		<div class="modal-body">
	  		<iframe id="mIframe"></iframe>
	    </div>
</div>

   <script type="text/javascript">
   var paramId=GetQueryString("paramId");
   if(paramId != null){
	   setTimeout('updatepageload()',500);
   }
   
   function updatepageload(){
   	//添加新tbody
       	$.ajax({
           headers : {
               "token" : localStorage.getItem("token"),
           }, 
           url : APIHost + '/repairInformation/findRepairById',
           type : 'POST',
           data : {
               id : paramId
           },
           timeout : 5000,
           dataType : 'json',
           success : function(obj) {
           	//参数qId通过findGoodsById方法获取到Modu对象值，赋值到页面字段中
           	console.log(obj.data);
           	$("#id").val(obj.data.id);
           	$("#orderNumber").val(obj.data.orderNumber);
           	$("#repairPeopleName").val(obj.data.repairPeopleName);
           	$("#repairPhone").val(obj.data.repairPhone);
           	$("#repairAddress").val(obj.data.repairAddress);
           	$("#detailAddress").val(obj.data.detailAddress);
           	/* var select7 = document.getElementById("incidentSource");
           	for (var i = 0; i < select7.options.length; i++){  
		        if (select7.options[i].value == obj.data.incidentSource){  
		            select7.options[i].selected = true;
		            break;  
		        }  
		    } */
           	var select1 = document.getElementById("incidentRank");
			for (var i = 0; i < select1.options.length; i++){  
		        if (select1.options[i].value == obj.data.incidentRank){  
		            select1.options[i].selected = true;
		            break;  
		        }  
		    }
			if("一般" == $("#incidentRank option:selected").val()){
				$("#emergenciesType").attr("disabled", true);
			}else{
				$("#emergenciesType").removeAttr("disabled");	
			}
			var select2 = document.getElementById("emergenciesType");
			for (var i = 0; i < select2.options.length; i++){  
		        if (select2.options[i].value == obj.data.emergenciesType){  
		            select2.options[i].selected = true;
		            break;  
		        }  
		    }
			 $("#repairTypeCode").val(obj.data.repairTypeCode);
			 var select3 = document.getElementById("repairType1");
			 var repairT = obj.data.repairTypeCode.split('-');
			 var t1 = repairT[0];
			 var t2 = repairT[1];
			for (var i = 0; i < select3.options.length; i++){  
		        if (select3.options[i].value == t1){  
		            select3.options[i].selected = true;
		            getType(t2);
		        }  
		    } 
			$("#repairType").val(obj.data.repairType);
			$("#repairPeopleId").val(obj.data.repairPeopleId);
			$("#appointmentTime").val(obj.data.appointmentTime);
			$("#appointmentTimeGo").val(obj.data.appointmentTimeGo);
			$("#repairEquipmentIds").val(obj.data.repairEquipmentIds);
			$("#repairEquipment").val(obj.data.repairEquipment);
			$("#faultDescription").val(obj.data.faultDescription);
			$("#repairDetailAddress").val((obj.data.repairAddress+obj.data.detailAddress));
			var re = obj.data.repairAddressCode.split('-');
			var adss1 = re[0];
			var adss2 = re[1];
			var adss3 = re[2];
			$("#repairAddress1 option").each(function() {
				 if($(this).val() === adss1){
                     $(this).attr("selected",true);
                    f1(adss2,adss3);
                 }
			 });
			$("#repairAddressCode").val(obj.data.repairAddressCode);
			$("#remark").val(obj.data.remark);
           },
           error : function() {
               console.log('错误')
           }
       }) 
   }
   function f1(adss2,adss3){
	   $("#repairAddress2").empty();
	   $.ajax({
			headers    : {
	               "token" : localStorage.getItem("token"),
	         },
			url:APIHost+"/repairInformation/getByParentCode",
			type:"POST",
			data:{pCode:$("#repairAddress1").val()},
			success:function(obj){
				for(var i = 0;i<obj.length;i++){
					var city = obj[i];
					$("#repairAddress2").append("<option value="+city.spaceCode+">"+city.spaceName+"</option>");
					$("#repairAddress2 option").each(function() {
						 if($(this).val() === adss2){
			               $(this).attr("selected",true);
			           }
					 })
				}
				f2(adss3);
			}
		});
	   
   }
   function f2(adss3){
	   $.ajax({
			headers    : {
	               "token" : localStorage.getItem("token"),
	         },
			url:APIHost+"/repairInformation/getByParentCode",
			type:"POST",
			data:{pCode:$("#repairAddress2").val()},
			success:function(obj){
				console.log(obj);
				for(var i = 0;i<obj.length;i++){
					var country = obj[i];
					$("#repairAddress3").append("<option value="+country.spaceCode+">"+country.spaceName+"</option>");
					 $("#repairAddress3 option").each(function() {
						 if($(this).val() === adss3){
			             $(this).attr("selected",true);
			         }
					 })
				}
			}
		});
	  
   }
   $("#detailAddress").change(function (){
	   $("#repairDetailAddress").val($("#repairAddress").val()+"-"+$("#detailAddress").val());
   })
   $('#incidentRank').change(function(){
		   if("紧急" == $("#incidentRank option:selected").val()){
			   $("#emergenciesType").removeAttr("disabled");
		   }else{
			   $("#emergenciesType").attr("disabled", true);
		   }
	   })
 //获取跳转地址的参数
   function GetQueryString(name){
        var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
        var r = window.location.search.substr(1).match(reg);
        if(r!=null)return  unescape(r[2]); return null;
   }  
 
   $("#repairEquipment").click(function(){  
	   insertItem('myModals','wy/repairInformation/repairEquipment_choice','mIframe',300);
  });
   
   
   // 表单验证
      $.validator.setDefaults({
          submitHandler: function() {
             // 调用提交
             formSubmit();
          }
      });
  	
  	$(document).ready(function() {
  		/*输入校验*/
          $("#inputForm").validate({
          	rules: {
                  
                   },
                   message:{
                 	 
                 }
         });
  		
  	});
      function formSubmit(){
  		var ajax_option={
  				headers    : {
 	                 "token" : localStorage.getItem("token"),
 	             }, 
  				url:APIHost + '/repairInformation/updateRepair',//默认是form action
  				success:function(response){
  					console.log(response);
  					if(response.data.msg=="success"){
  						$.jBox.alert("保存成功","提示");
      					setTimeout(function(){
      						//parent.location.reload();
                              $('#updateRepair .close', window.parent.document).click();
                              parent.pageload();
       	            	},500)
  					}
  					else if(response.msg=="exists"){
  						$.jBox.alert("数据已存在","提示");
  					}
  					else{
  						$.jBox.alert("错误","提示");
  					}
  					
  				
     				}
         		}
         		
         		 $("#inputForm").ajaxSubmit(ajax_option);  
} 
	 
		function getType(t2){
			var repairType1 = $("#repairType1 option:selected").val();
		  	$.ajax({
				headers    : {
		               "token" : localStorage.getItem("token"),
		         },
				url:APIHost+"/repairInformation/getTypeByCode",
				type:"POST",
				data:{pCode:repairType1},
				success:function(obj){
					$("#repairType2").append("<option value=''></option>");
					for(var i = 0;i<obj.length;i++){
						var city = obj[i];
						$("#repairType2").append("<option value="+city.typeId+">"+city.typeCode+"</option>");
						$("#repairType2 option").each(function() {
							 if($(this).val() == t2){
				             	$(this).attr("selected",true);
				         	 }
						})
					}
					
					
				}
			});
			
    	}
	  
    </script>

</body></html>