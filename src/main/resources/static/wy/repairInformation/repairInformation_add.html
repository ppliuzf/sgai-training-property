<!DOCTYPE html>
<html><head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<meta name="renderer" content="webkit"><meta http-equiv="X-UA-Compatible" content="IE=8,IE=9,IE=10">
<meta http-equiv="Expires" content="0"><meta http-equiv="Cache-Control" content="no-cache"><meta http-equiv="Cache-Control" content="no-store">
<script src="../static/jquery/jquery-1.8.3.min.js" type="text/javascript"></script>
<link href="../static/bootstrap/2.3.1/css_cerulean/bootstrap.min.css" type="text/css" rel="stylesheet">
<script src="../static/bootstrap/2.3.1/js/bootstrap.min.js" type="text/javascript"></script>
<link href="../static/bootstrap/2.3.1/awesome/font-awesome.min.css" type="text/css" rel="stylesheet">
<!--[if lte IE 7]><link href="../static/bootstrap/2.3.1/awesome/font-awesome-ie7.min.css" type="text/css" rel="stylesheet" /><![endif]-->
<script src="../static/bootstrap/bsie/js/bootstrap-ie.min.js" type="text/javascript"></script><![endif]-->
<script src="../static/media/js/main.js" type="text/javascript"></script>
<!-- <link href="../static/jquery-select2/4.0/select2.min.css" rel="stylesheet"> -->
<!-- <script src="../static/jquery-select2/4.0/select2.min.js" type="text/javascript"></script> -->
<script src="../static/jquery-select2/4.0/zh-CN.js" type="text/javascript"></script>
<link href="../static/jquery-validation/1.11.0/jquery.validate.min.css" type="text/css" rel="stylesheet">
<script src="../static/jquery-validation/1.11.0/jquery.validate.min.js" type="text/javascript"></script>
<link href="../static/jquery-jbox/2.3/Skins/Bootstrap/jbox.min.css" rel="stylesheet">
<script src="../static/jquery-jbox/2.3/jquery.jBox-2.3.min.js" type="text/javascript"></script>
<script src="../static/My97DatePicker/WdatePicker.js" type="text/javascript"></script><link href="../static/My97DatePicker/skin/WdatePicker.css" rel="stylesheet" type="text/css">
<script src="../static/common/mustache.min.js" type="text/javascript"></script>
<link href="../static/common/smart.min.css" type="text/css" rel="stylesheet">
<script src="../static/common/smart.min.js" type="text/javascript"></script>
<script src="../static/jquery-form/3.51.0/jquery.form.js" type="text/javascript"></script>
<link href="../static/media/css/my-style.css" rel="stylesheet" type="text/css"/>
<link rel="stylesheet" type="text/css" href="../static/upload/webuploader.css" />
<script type="text/javascript">var ctx = '/admin', ctxStatic='/static';</script>
<script src="../../config/smart-common.js" type="text/javascript"></script>
<script type="text/javascript" src="../static/upload/webuploader.js"></script>
<script src="../static/wy/area.js" type="text/javascript"></script>
<script src="../static/wy/type.js" type="text/javascript"></script>
<style type="text/css">
	.hand{
		cursor:pointer;
	}
    .custom-box2 li{
    	float: none!important;
		line-height: 30px!important;
		z-index: 1000;
		margin-bottom: -33px;
		background-color: #ddd
    }
          
             select {
            width: 180px;
        }

        input {
            width: 151px;
        }
        li{
            margin-top: 20px ;
            margin-left:-31px;
            list-style: none;
        }
        li>label{
        	width: 80px;
    		text-align: right;
        }
        
        .form-search label {
   			 margin-left: 14px;
			}
			
        label.error {
		    background: url(../static/jquery-validation/1.11.0/images/unchecked.gif) no-repeat 85px 3px;
		    padding-left: 4px;
		    padding-bottom: 2px;
		    font-weight: bold;
		    color: #ea5200;
		    display: block;
		    margin-left: 10px;
		    width:160px !important;
		}
		.help-block, .help-inline {
		    color: #aaa;
		    position: absolute;
		    right: -10px;
		    top: 3px;
		}
		
		.form-search .ul-form li label {
			    width: 90px;
			    text-align: right;
			}

		.form-search .ul-form li {
		    float: left;
		    height: 34px;
		    line-height: 31px;
		    list-style: none;
		     position: relative;
		}
</style>
<title>维修信息添加</title>
<meta name="decorator" content="default"/>
 
</head>
<body>
	 	<div class="table_infor">
	        <div class="table_title">
	            <i class="icon-table"></i><span>新增报修</span>
	        </div>
	    </div>
<div  style=" float:left; display:inline;width:50%">
<form id="inputForm" class="breadcrumb form-horizontal"  method="post" novalidate="novalidate"  style="margin-left: 26px;">
    <input id="id" name="id" type="hidden" />
    <input id="pictNames"  name="pictNames"  type="hidden"  value="">
<script type="text/javascript">top.$.jBox.closeTip();</script>
<ul  class="ul-form"  style="padding-left: 12px;heignt:450px !important;">
<li>
    <label><b>报修人:</b></label>
        	<input id="repairPeopleName"  name="repairPeopleName" class="required"  type="text" value="" maxlength="50">
			<span class="help-inline"><font color="red">*</font> </span>
			<ul class="custom-box2"  style="display: block;margin-left: 300px;max-height: 84px;"></ul>
   </li>
   <li>     	 
        	 <label ><b>报修电话:</b></label>
        	  <input id="repairPhone" class="required"  type="text" value="" maxlength="50">
        	<input id="repairPeopleId"  name="repairPeopleId" class="required"  type="hidden" value="" maxlength="50">
	         <span class="help-inline"><font color="red">*</font> </span>
	     

</li>

<li>
   <label><b>报修地址:</b></label>
   <select id="repairAddress1" class="input-mini" name="repairAddress1" tabindex="-1" style="width: 168px;">
        			<option value=""></option>
        		</select>
    			<select id="repairAddress2"  class=" input-mini" name="repairAddress2" tabindex="-1"></select>
    			<select id="repairAddress3"  class=" required input-mini" name="repairAddress3" tabindex="-1" style="width: 140px;"></select>
    			
    			<input type="hidden" id="repairAddress" name="repairAddress" />
    			<input type="hidden" id="repairAddressCode" name="repairAddressCode" />
       		<span class="help-inline"><font color="red">*</font> </span>
</li>

<li>
 <label><b>详细地址:</b></label>
            <input id="detailAddress" name="detailAddress" class="required  input-xlarge" type="text" value="" maxlength="50" style="width: 391px;">
      		<span class="help-inline"><font color="red">*</font> </span>
</li>
<li>
     <label  ><b>事件级别:</b></label>
     		         <select id="incidentRank"  name="incidentRank" class="input-mini " tabindex="-1"style="width: 166px;">
	            	<option value=""></option>
	            	<option value="一般">一般</option>
	            	<option value="紧急">紧急</option>
	             </select>
	        	<span class="help-inline"><font color="red">*</font> </span>
</li>
<li>
 <label><b>事件分类:</b></label>
	        	<select id="emergenciesType"  name="emergenciesType" class="input-mini " tabindex="-1" style="width: 165px;">
	            	<option value=""></option>
	            	<option value="部长以上">部长以上</option>
	            	<option value="停电">停电</option>
	            	<option value="电梯故障">电梯故障</option>
	            	<option value="喷淋头喷水">喷淋头喷水</option>
	            	<option value="火灾">火灾</option>
	            	<option value="发水">发水</option>
	             </select>
	        	<span class="help-inline"><font color="red">*</font> </span>
</li>
<li>
 <label ><b>报修类型:</b></label>
 	 <select id="repairType1" name="repairType1" class="input-mini" tabindex="-1"style="width: 166px;">
	            	<option value=""></option>
	            	<!-- <option value="强电维修">强电维修</option>
	            	<option value="弱电维修">弱电维修</option>
	            	<option value="空调维修">空调维修</option>
	            	<option value="给排水维修">给排水维修</option>
	            	<option value="电梯维修">电梯维修</option>
	            	<option value="综合维修">综合维修</option> -->
	             </select>
	             <select id="repairType2" name="repairType2" class="required input-mini" tabindex="-1"style="width: 166px;">
	             </select>
	             <input id="repairType"  name="repairType" class="required" type="hidden" value="" maxlength="50">
	             <input id="repairTypeCode"  name="repairTypeCode" class="required" type="hidden" value="" maxlength="50">
	        	<span class="help-inline"><font color="red">*</font> </span>

</li>
<li>
 <label ><b>预约时间从:</b></label>
    <input id="appointmentTime"  onclick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss',isShowClear:false,maxDate:'#F{$dp.$D(\'appointmentTimeGo\',{d:-1});}'})" name="appointmentTime" class=" Wdate"   type="text" value="" maxlength="50">
	        	<b>到</b>
	        	<input id="appointmentTimeGo" onclick="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss',isShowClear:false,minDate:'#F{$dp.$D(\'appointmentTime\',{d:1});}'})" name="appointmentTimeGo" class="required Wdate" type="text" value="" maxlength="50" style="width:205px">
	        		<span class="help-inline"><font color="red">*</font> </span>
</li>
<li>
	        <label class=""><b>报修设备:</b></label>
	            <input id="repairEquipment" style="width:393px;height:23px;" name="repairEquipment" type="text" value="" maxlength="50">
	            <input id="repairEquipmentIds"  name="repairEquipmentIds" type="hidden" value="" maxlength="50">
</li>
<li>
  <label ><b>故障描述:</b></label>
	<textarea rows=""  id="faultDescription" name="faultDescription" style="width:393px;resize:none;"></textarea>
</li>
<li>
       <label><b>备注:</b></label>
	<input id="remark" style="width:393px;height:23px;" name="remark"  type="text" value="" maxlength="50">
           <div id="filePicker"  style="float: right;margin: 10px 99px 0px 0px;">选择图片</div>
</li>
</ul>
		<div id="uploader-demo" style="margin-top:20px;" class="wu-example">
        <!--用来存放item-->
        <div id="fileList" class="uploader-list" style="float:left;margin-bottom:-71px;margin-left: 110px;"></div>
        <div class="btns" style="clear:both; margin-left:77px;">
	        
<!-- 	        <div id="bu" style="margin-top:10px;">
	        	<button id="ctlBtn"  class="btn btn-default"  type="button">开始上传</button>
	        </div> -->
    	</div>
		    </div>
    <div class="form-actions"  style="margin: 70px auto;">
    	<!-- <input id="btnSubmit" onclick="submitData()" class="btn btn-primary" value="提  交">&nbsp; -->
    	<input id="btnSubmit"  type="submit"  class="btn btn-primary"  value="提  交">&nbsp;
    </div>
</form>
</div>

<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true"  >
		 <div class="modal-header">
		    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		    <h4 id="myModalLabel"><b>请确认报修信息</b></h4>
		 </div>
		<div class="modal-body">
	  		<iframe id="Iframe"></iframe>
	    </div>
</div>
<div id="myModals" class="modal hide fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="width:800px;margin-left: -392px;margin-top: -47px;">
		 <div class="modal-header">
		    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
		    <h4 id="myModalLabel"><b>设备信息</b></h4>
		 </div>
		<div class="modal-body">
	  		<iframe id="mIframe"></iframe>
	    </div>
</div>
<div  style="display:inline-block;background:#e3e3e3;width:50%;float:left;min-height:724px;overflow-y:hidden;float:left; display:inline">
	<h4>用户信息</h4>
	<div style="margin-top: 15px;">
		 <label class="control-label"><b>姓名:</b></label>
		 <span id="pName"></span>
	</div>
	<div style="margin-top: 6px;"> 
		 <label class="control-label"><b>联系电话:</b></label>
		 <span id="pTel"></span>
	</div>
	<div style="margin-top: 6px;">
		 <label id="" class="control-label"><b>过往报修地址:</b></label>
		 	        <div class="controls">
	          <select id="address"  name="address"   class="query_input" onchange="choice()"  style="width: 270px;"></select>
	        </div>
	       
	</div>
	<div style="margin-top: 10px;">
		 <label id="history" class="control-label"><b>报修历史:</b></label>
	<table id="privilegeTable" class="table table-striped table-bordered table-condensed">
    	<thead>
	    	<tr>
	    		<th>序号</th>
	    		<th>日期</th>
	    		<th>报修类型</th>
	    	</tr>
    	</thead>
    	<tbody>
		</tbody>
    </table>
	</div>
</div>

   <script type="text/javascript">

   $(function(){  
		pageRightContent();
		repairPerson();
		//pageload();
	});  
	   $('#incidentRank').change(function(){
		   if("紧急" == $("#incidentRank option:selected").val()){
			   $("#emergenciesType").removeAttr("disabled");
		   }else{
			   $("#emergenciesType").attr("disabled", true);
		   }
	   })

        function submitData(){
         	var repairPeopleId = $("#repairPeopleId").val();
         	var repairPeopleName = $("#repairPeopleName").val();
        	var repairPhone = $("#repairPhone").val();
        	var repairAddress = $("#repairAddress").val();
        	var detailAddress = $("#detailAddress").val();
        	var incidentRank = $("#incidentRank option:selected").val();
        	var emergenciesType = $("#emergenciesType option:selected").val();
        	var repairType = $("#repairType").val();
        	var repairTypeCode = $("#repairTypeCode").val();
        	var appointmentTime = $("#appointmentTime").val();
        	var repairEquipment = $("#repairEquipment").val();
        	var faultDescription = $("#faultDescription").val();
        	var repairEquipmentIds = $("#repairEquipmentIds").val();
        	var repairAddressCode = $("#repairAddressCode").val();
        	//var incidentSource = $("#incidentSource option:selected").val();
        	var appointmentTimeGo = $("#appointmentTimeGo").val();
        	var remark = $("#remark").val();
        	var pictNames = $("#pictNames").val();
        	
        	
        	var url = encodeURI(APIHost + "/wy/repairInformation/repairInformation_detail.html?repairPeopleName="+repairPeopleName+"&repairPhone="+repairPhone+"&repairAddress="+repairAddress+"&detailAddress="+detailAddress+"&incidentRank="+incidentRank+"&emergenciesType="+emergenciesType+"&repairType="+repairType+"&appointmentTime="+appointmentTime+"&repairEquipment="+repairEquipment+"&faultDescription="+faultDescription+"&repairEquipmentIds="+repairEquipmentIds+"&repairAddressCode="+repairAddressCode+"&repairPeopleId="+repairPeopleId+"&remark="+remark+"&appointmentTimeGo="+appointmentTimeGo+"&repairTypeCode="+repairTypeCode+"&pictNames="+pictNames);
        	$('#myModal').modal('show');
        	$("#Iframe").attr("src",url);
        	$("#Iframe").css("height","400px"); 
        }
	  
	   
	   function pageload(n, s){
		 //判断是否传pageSize
			var pageSize = $('.page-size option:selected').val();
			if(!$.isNumeric(s)){
				s = pageSize;
			} 
			//删除旧tbody
			var contentTableSub = document.getElementById("privilegeTable");
			var oldTbody = document.getElementById("privilegeTbody");
			if (oldTbody != null) {
				contentTableSub.removeChild(oldTbody);
			}
			var pId = $("#repairPeopleId").val();
			var phoneN = $("#repairPhone").val();
	  	    //添加新tbody
	  	    $.ajax({
	  	       headers : {
	  	            "token" : localStorage.getItem("token"),
	  	        },
	  	        url : APIHost + '/repairInformation/getLists',
	  	        type : 'POST',
	  	        async : false, //或false,是否异步
	  	        data : {
	  	        	pageNo : n,
					pageSize : s,
	  	            repairPeopleId : pId,
	  	            phoneNumber : phoneN
	  	        },
	  	        timeout : 5000,
	  	        dataType : 'json',
	  	        success : function(res) {
					if(res.data.list.length != 0){
						var p = res.data.list[0];
		  	        	$("#pName").text(p.repairPeopleName);
		  	        	$("#pTel").text(p.repairPhone);
		  	        	//pageContent(res.data);
						var newTbody = document.createElement("tbody");
						newTbody.setAttribute("id", "privilegeTbody");
						
						var repairData = res.data.list;
						for(var i = 0;i<repairData.length;i++){
							var repairs = repairData[i];
					//		$("#address").after("<p><span>"+repairs.repairAddress+"</span> &nbsp&nbsp<a class='hand' value="+repairs.repairAddressCode+" onclick='choice(this)'>选择</a></p>");
							var tr = document.createElement("tr");
							//序号
							var td11=document.createElement("td");
							td11.innerHTML=i+1;
							td11.className="order_number";
							tr.appendChild(td11);
							
							var td1 = document.createElement("td");
							td1.innerHTML = repairs.appointmentTime;
							tr.appendChild(td1);
							
							var td2 = document.createElement("td");
							td2.innerHTML = repairs.repairType;
							tr.appendChild(td2);
							newTbody.appendChild(tr);
						}
						contentTableSub.appendChild(newTbody);
						//table下每一行tr选中高亮
						inputCheck();
						//调用操作按钮方法
						handelBtn();
						//内容自适应iframe高度
					    setIframeHeight(parent.document.getElementById('mainFrame'));
						
					}
					
	  	        },
	  	        error : function() {
	  	            console.log('错误')
	  	        }
	  	    })
			
	   }
	   $("#repairEquipment").click(function(){  
		   insertItem('myModals','wy/repairInformation/repairEquipment_choice','mIframe',500);
      });
		  	
	   function choice(index){
			var options=$("#address option:selected");
			var address=options.val();
		//   var address = $(index).attr("value");
		   //$("#repairAddress").val(address);
		   $("#repairAddress").val("");
		   $("#repairAddressCode").val("");
		   var re = address.split('-');
		 	var select4 = document.getElementById("repairAddress1");
			var select5 = document.getElementById("repairAddress2");
			var select6 = document.getElementById("repairAddress3");
			var adss1 = re[0];
			var adss2 = re[1];
			var adss3 = re[2];
			 $("#repairAddress1 option").each(function() {
				 if($(this).val() == adss1){
                     $(this).attr("selected",true);
                    f1(adss2,adss3);
                 }
			 })
	   }
	   
	   $("#repairAddress").click(function(){  
		   $.ajax({
	           headers : {
	               "token" : localStorage.getItem("token"),
	           }, 
	           url : APIHost + '/repairInformation/getByParentCode',
	           type : 'POST',
	           data : {
	           },
	           timeout : 5000,
	           dataType : 'json',
	           success : function(obj) {
	           	//参数qId通过findGoodsById方法获取到Modu对象值，赋值到页面字段中
	        //		console.log(obj);
	           },
	           error : function() {
	               console.log('错误')
	           }
	       }) 
      });
	
	   function repairPerson(){
		   $.ajax({
	           headers : {
	               "token" : localStorage.getItem("token"),
	           }, 
	           url : APIHost + "/member/getList",
	           type : 'POST',
	           data : {
	           },
	           timeout : 5000,
	           dataType : 'json',
	           success : function(obj) {
	           	//参数qId通过findGoodsById方法获取到Modu对象值，赋值到页面字段中
	           		var d = obj.data.list;
	        		for(var i = 0;i<d.length;i++){
						$("#repairPeopleName").append("<option value="+d[i].id+">"+d[i].chineseName+"</option>");
					}
	           },
	           error : function() {
	               console.log('错误')
	           }
	       }) 
	   }
	  
	   function f1(adss2,adss3){
		   $("#repairAddress2").empty();
			//$("#repairAddress3").empty();
		   $.ajax({
				headers    : {
		               "token" : localStorage.getItem("token"),
		         },
				url:APIHost+"/repairInformation/getByParentCode",
				type:"POST",
				data:{pCode:$("#repairAddress1").val()},
				success:function(obj){
					for(var i = 0;i<obj.length;i++){
						var city = obj[i];
						$("#repairAddress2").append("<option value="+city.spaceCode+">"+city.spaceName+"</option>");
						$("#repairAddress2 option").each(function() {
							 if($(this).val() == adss2){
				               $(this).attr("selected",true);
				           }
						 })
					}
					f2(adss3);
				}
			});
		   
	   }
	   function f2(adss3){
		   $("#repairAddress3").empty();
		   $.ajax({
				headers    : {
		               "token" : localStorage.getItem("token"),
		         },
				url:APIHost+"/repairInformation/getByParentCode",
				type:"POST",
				data:{pCode:$("#repairAddress2").val()},
				success:function(obj){
					$("#repairAddress3").append("<option value=''></option>");
					for(var i = 0;i<obj.length;i++){
						var country = obj[i];
						$("#repairAddress3").append("<option value="+country.spaceCode+">"+country.spaceName+"</option>");
						 $("#repairAddress3 option").each(function() {
							 if($(this).val() == adss3){
				             $(this).attr("selected",true);
				         }
						 })
					}
					$("#repairAddress").val($("#repairAddress1 option:selected").text()+"-"+$("#repairAddress2 option:selected").text()+"-"+$("#repairAddress3 option:selected").text());	
					$("#repairAddressCode").val($("#repairAddress1 option:selected").val()+"-"+$("#repairAddress2 option:selected").val()+"-"+$("#repairAddress3 option:selected").val());	
					
				}
			});
		  
	   }
	   //姓名模糊搜索会员
	   $("#repairPeopleName").keyup(function(){
			var repairPeopleName = $("#repairPeopleName").val();
			$(".custom-box2").css("display","block");
			//ajax请求成功后拼接下拉框内容
			if(repairPeopleName!=''){
				$.ajax({
						headers: {"token": localStorage.getItem("token")},
						url : APIHost + '/repairInformation/showName',
						type: "POST",
						data: {repairPeopleName:repairPeopleName},
						success: function(response) {
							var items=response.data;
							var repairPeopleHtml='';
							for (i=0;i<items.length ;i++ ){
								repairPeopleHtml+='<li p='+items[i].id+'>'+items[i].chineseName+'</li>';
							}
							$(".custom-box2").html(repairPeopleHtml);
						}
				});
			}else{
				$(".custom-box2").empty();
			}
		});
	 //模糊查询下拉框
		$(".custom-box2").on("click","li",function(){
			var name=$(this).html();
			var id=$(this).attr("p");
			$("#repairPeopleName").val(name);
			$("#repairPeopleId").val(id);			
			$(".custom-box2").empty().css("display","none");
	        var obj=document.getElementById('address');
	        obj.options.length=0;//移除options 
			getRepairInformation(id);
		})
		
		function getRepairInformation(repairPeopleId){
			   $("#pName").empty();
			   $("#pTel").empty();
		       $("#address").siblings('p').remove();
				 
		       jQuery.ajax({
			 		headers: {"token": localStorage.getItem("token")},
				 	url : APIHost + '/call/findAddress',
					type: "POST",
				    dataType: 'json',
					data: {id:repairPeopleId},
					success: function(data) {
						var items=data;
						var item=items.mlist;
		    			$('#address').append("<option hidden='hidden' value=''></option>");
						for(var i=0;i<item.length;i++){
		    				$('#address').append("<option value="+item[i].repairAddressCode+">"+item[i].repairAddress+"</option>");
		    				//$("#address").after("<p><span>"+item[i].repairAddress+"</span> &nbsp&nbsp<a class='hand' value="+item[i].repairAddressCode+" onclick='choice(this)'>选择</a></p>");
		    			}
						$('#address').find("option").eq(1).prop("selected",true);//默认选中第一个
				}
		})
		       
		       pageload();
					$.ajax({
						headers    : {
				               "token" : localStorage.getItem("token"),
				         },
						url:APIHost + "/member/findMemberById",
						type:"POST",
						async:false,
						data:{id : repairPeopleId},
						success:function(obj){
							$("#pName").text(obj.data.chineseName);
							$("#pTel").text(obj.data.phoneNumber);
							$("#repairPhone").val(obj.data.phoneNumber);
							$("#repairAddress").val(obj.data.repairAddress);
							$("#repairAddressCode").val(obj.data.repairAddressCode);
							if(obj.data.repairAddressCode !=null){
								var re = obj.data.repairAddressCode.split('-');
							 	var select4 = document.getElementById("repairAddress1");
								var select5 = document.getElementById("repairAddress2");
								var select6 = document.getElementById("repairAddress3");
								var adss1 = re[0];
								var adss2 = re[1];
								var adss3 = re[2];
								 $("#repairAddress1 option").each(function() {
									 if($(this).val() == adss1){
					                     $(this).attr("selected",true);
					                    f1(adss2,adss3);
					                 }
								 })
							}
							
						}
					});
					
	 	}
	 
	 
		// 表单验证
	    $.validator.setDefaults({
	        submitHandler: function() {
	           // 调用提交
	           submitData();
	        }
	    });
		
		$(document).ready(function() {
	        jQuery.validator.addMethod("isphoneNum", function (value, element) {
	            var length = value.length;
	            return this.optional(element) || (length == 11 );
	        }, "请写长度为11位的号码");
			/*输入校验*/
	        $("#inputForm").validate({
	        	rules: {
	        		repairPeopleName:{
	                	required: true
	                },
	                repairPhone:{
	                	required: true,
	                	number:true,
	                	isphoneNum:true
	                },
	                incidentSource:{
	                	required: true
	                },
	                incidentRank: {
	                    required: true
	                },
	                repairType2:{
	                	required: true
	                }
                }
	       });
			
		});
	  function  uploadPictrue(){
		   insertItem('pictrueModal','wy/repairInformation/uploadImage','pIframe',500);
	  }
    </script>
<script type="text/javascript">
		var repairId = 5;
		var url = APIHost + "/repair/upImg/uploadImg";
		$(function() {
		    var $ = jQuery, $list = $('#fileList'),
		    // 优化retina, 在retina下这个值是2
		    ratio = window.devicePixelRatio || 1,
		    // 缩略图大小
		    thumbnailWidth = 50 * ratio, thumbnailHeight = 50 * ratio,
		    // 初始化Web Uploader
		    uploader = WebUploader.create({
		        // 自动上传。
		        auto : true,
		        // swf文件路径
		        swf : 'static/upload/Uploader.swf',
		        // 文件接收服务端。
		        server : url,
		        formData: {"repairId":repairId},
		        // 选择文件的按钮。可选。
		        // 内部根据当前运行是创建，可能是input元素，也可能是flash.
		        pick : '#filePicker',
		        // 只允许选择文件，可选。
		        accept : {
		            title : 'Images',
		            extensions : 'gif,jpg,jpeg,bmp,png',
		            mimeTypes : 'image/*'
		        },
		        fileNumLimit : 4, //限制上传个数
		        fileSingleSizeLimit : 2048000
		    //限制单个上传图片的大小
		    });
		
		    // 当有文件添加进来的时候
		    uploader
		            .on(
		                    'fileQueued',
		                    function(file) {
		                        var $li = $('<div id="' + file.id + '" class="file-item thumbnail" style="float:left;width:80px;margin-left: 17px;">'
		                                + '<img>'
		                                + '<div>'
		                                + file.name + '</div>'+ '</div>'), 
		                                $img = $li.find('img');
		                        $list.append($li);
		
		                        // 创建缩略图
		                        uploader.makeThumb(file, function(error, src) {
		                            if (error) {
		                                $img.replaceWith('<span>不能预览</span>');
		                                return;
		                            }
		
		                            $img.attr('src', src);
		                        }, thumbnailWidth, thumbnailHeight);
		                    });
		
		    // 文件上传过程中创建进度条实时显示。
		    uploader.on('uploadProgress', function(file, percentage) {
		        var $li = $('#' + file.id), $percent = $li.find('.progress span');
		
		        // 避免重复创建
		        if (!$percent.length) {
		            $percent = $('<p class="progress"><span></span></p>').appendTo(
		                    $li).find('span');
		        }
		
		        $percent.css('width', percentage * 100 + '%');
		    });
		
		    // 文件上传成功，给item添加成功class, 用样式标记上传成功。
		    uploader.on('uploadSuccess', function(file,response) {
		    	var $li = $('#' + file.id), $success = $li.find('div.success');
		    	// 避免重复创建
		        if (!$success.length) {
		            $success = $('<div class="success"></div>').appendTo($li);
		        }
		        $success.text('上传成功');
		        var pict=$("#pictNames").val();
		        if(pict !=""){
		        	pict=pict+","+response.url;
		        	$("#pictNames").val(pict);
		        //	console.log(pict);
		        }else{
		        	$("#pictNames").val(response.url);
		        }
		      console.log(response);
		    });
		
		    // 文件上传失败，现实上传出错。
		    uploader.on('uploadError', function(file) {
		        var $li = $('#' + file.id), $error = $li.find('div.error');
		
		        // 避免重复创建
		        if (!$error.length) {
		            $error = $('<div class="error"></div>').appendTo($li);
		        }
		
		        $error.text('上传失败');
		    });
		    //开始上传
		    $("#ctlBtn").on('click', function() {  
		        uploader.upload();  
		    }); 
		    
		    /* $("#resBtn").on('click', function() {  
		    	 for (var i = 0; i < uploader.getFiles().length; i++) {
		    	        uploader.removeFile(uploader.getFiles()[i]);
		    	    }
		    	   uploader.reset();	  
		    }); */
		
		    // 完成上传完了，成功或者失败，先删除进度条。
		    uploader.on('uploadComplete', function(file) {
		        $('#' + file.id).find('.progress').remove();
                parent.pageload();
		    });
		    
		    uploader.on("error", function (type) {
		        if (type == "Q_TYPE_DENIED") {
		           alert("请上传JPG、PNG、GIF、BMP、JPEG格式文件");
		        } else if (type == "Q_EXCEED_SIZE_LIMIT") {
		        	alert("文件大小不能超过2M");
		        }else if (type == "Q_EXCEED_NUM_LIMIT"){
		            alert("最多上传4张图片");
		        }else{
		        	alert("图片重复,请重新上传");
		        }
		    });
		    
		});
		
</script>
</body></html>