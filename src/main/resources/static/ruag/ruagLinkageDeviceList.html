<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=8,IE=9,IE=10">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta http-equiv="Cache-Control" content="no-store">
    <script src="../static/jquery/jquery-1.8.3.min.js" type="text/javascript"></script>
    <link href="../static/bootstrap/2.3.1/css_cerulean/bootstrap.min.css" type="text/css" rel="stylesheet">
    <link href="../static/bootstrap/2.3.1/awesome/font-awesome.min.css" type="text/css" rel="stylesheet">

    <!--分页  -->
    <script src="../static/paginator/bootstrap-paginator.js" type="text/javascript"></script>
    <!-- 公共样式表	，公共方法 -->
    <link href="../static/media/css/my-style.css" rel="stylesheet" type="text/css"/>
    <script src="../static/media/js/main.js" type="text/javascript"></script>

    <link href="../static/jquery-select2/4.0/select2.min.css" rel="stylesheet">
    <link href="../static/jquery-validation/1.11.0/jquery.validate.min.css" type="text/css" rel="stylesheet">
    <link href="../static/jquery-jbox/2.3/Skins/Bootstrap/jbox.min.css" rel="stylesheet">
    <link href="../static/My97DatePicker/skin/WdatePicker.css" rel="stylesheet" type="text/css">
    <link href="../static/common/smart.min.css" type="text/css" rel="stylesheet">
    <script src="../static/bootstrap/2.3.1/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../static/jquery-select2/4.0/select2.min.js" type="text/javascript"></script>
    <script src="../static/jquery-select2/4.0/zh-CN.js" type="text/javascript"></script>
    <script src="../static/jquery-validation/1.11.0/jquery.validate.min.js" type="text/javascript"></script>
    <script src="../static/jquery-jbox/2.3/jquery.jBox-2.3.src.js" type="text/javascript"></script>
    <script src="../static/My97DatePicker/WdatePicker.js" type="text/javascript"></script>
    <script src="../static/common/mustache.min.js" type="text/javascript"></script>
    <script src="../static/common/smart.min.js" type="text/javascript"></script>
    <script src="../config/smart-common.js" type="text/javascript"></script>
    <script src="../static/jquery-form/3.51.0/jquery.form.js" type="text/javascript"></script>
    <link href="../static/jquery-ztree/3.5.12/css/zTreeStyle/zTreeStyle.min.css" rel="stylesheet" type="text/css"/>
    <script src="../static/jquery-ztree/3.5.12/js/jquery.ztree.all-3.5.min.js" type="text/javascript"></script>
    <style type="text/css">
        .ntspalctexts {
            width: 100%;
            background-color: #fff;
            min-height: 60px;
        }

        .wzh_1 {
            color: #4A4A4A;
            text-decoration: none;
        }

        .wzh_1:hover {
            color: #999;
            text-decoration: none;
        }

        .wzh_1:visited {
            color: #999;
            text-decoration: none;
        }

        .NATIVE {
            font-size: 12px;
            font-family: 新宋体;
        }

        .form-search .ul-form li label {
            width: 80px;
            text-align: right;
        }

        .form-horizontal .control-label {
            width: 140px;
        }

        #tableFront .table_infor,
        #tableNext .table_infor {
            float: none !important;
            margin-bottom: 5px;
        }

        #tableFront .table_infor .small_btn,
        #tableNext .table_infor .small_btn {
            margin: -5px 0;
        }

        .table_title {
            display: block;
        }

        .table_infor .btn_add {
            width: auto !important;
        }
    </style>
    <script type="text/javascript">
        var ctx = '/admin', ctxStatic = '/static';
        var GetFrontList = '/ruag/ruag/ruagLinkaageFrontDevice/getListLinkaageFrontDevice';
        var GetNextList = '/ruag/ruag/ruagLinkaageNextDevice/getListLinkaageNextDevice';
        var DeleteFrontList = '/ruag/ruag/ruagLinkaageFrontDevice/delete';
        var DeleteNextList = '/ruag/ruag/ruagLinkaageNextDevice/delete';
        var getList = "/admin/mdm/mdmdeviceparameter/mdmDeviceParameter/findByDeviceClassCode"
        var saveUrl = "/ruag/ruag/ruagLinkageDeviceParamSet/saveCheckedParameters"
    </script>
    <title>设备设置</title>
    <meta name="decorator" content="default">
    <script type="text/javascript">
        var paramId = GetQueryString("id");
        var status = GetQueryString("status");
        $(document).ready(function () {
            makeBread();
            //左侧分页内容
            statusSet();
            getProf();
            getNextProf();
            paginationFront();
            paginationNext();
            pageFrontload();
            pageNextload();
        });

        function statusSet() {
            if (status == 'Y') {
                $("#btnInsert").css("display", "none");
                $("#btnSetUp").css("display", "none");
                $("#btnInsertLink").css("display", "none");
                $("#btnSetUpLink").css("display", "none");
                $("#btnDeleteF").css("display", "none");
                $("#btnDeleteN").css("display", "none");

            } else {
                $("#btnInsert").removeAttr("display");
                $("#btnSetUp").removeAttr("display");
                $("#btnInsertLink").removeAttr("display");
                $("#btnSetUpLink").removeAttr("display");
                $("#btnDeleteF").removeAttr("display");
                $("#btnDeleteN").removeAttr("display");
            }
        }

        function paginationFront() {
            var pageRightContent = '<div class="row-fluid">'
                + '<h3 class="page-null">暂无数据！</h3>'
                + '<div class="page-box span3" style="padding-top: 15px;">'
                + '<span id="pageNow"></span><span>-</span><span id="allPage"></span>页&nbsp;&nbsp;<span>共<span id="allNum"></span>项</span>&nbsp;&nbsp;'
                + '<select class="page-size">'
                + '<option value="10">10</option>'
                + '<option value="20">20</option>'
                + '<option value="50">50</option>'
                + '<select>&nbsp;项/页'
                + '</div>'
                + '<div id="page_div">'
                + '</div>'
                + '</div>';
            $("#tableFront").append(pageRightContent);

            $("#tableFront .page-size").on("change", function () {
                var pageSize = this.value;
                $("#tableFront #pageSize").val(pageSize);
                pageFrontload(page, pageSize);
            });
        }

        function paginationNext() {
            var pageRightContent = '<div class="row-fluid">'
                + '<h3 class="page-null">暂无数据！</h3>'
                + '<div class="page-box span3" style="padding-top: 15px;">'
                + '<span id="pageNow"></span><span>-</span><span id="allPage"></span>页&nbsp;&nbsp;<span>共<span id="allNum"></span>项</span>&nbsp;&nbsp;'
                + '<select class="page-size">'
                + '<option value="10">10</option>'
                + '<option value="20">20</option>'
                + '<option value="50">50</option>'
                + '<select>&nbsp;项/页'
                + '</div>'
                + '<div id="page_div">'
                + '</div>'
                + '</div>';
            $("#tableNext").append(pageRightContent);

            $("#tableNext .page-size").on("change", function () {
                var pageSize = this.value;
                $("#tableNext #pageSize").val(pageSize);
                pageNextload(page, pageSize);
            });
        }

        function pageFrontContent(data) {
            $("#tableFront #page_div").empty();
            var allPageNum = Math.ceil(data.count / data.pageSize);
            var page = data.pageNo;
            $("#tableFront #pageNow").html(page);
            $("#tableFront #allNum").html(data.count);
            $("#tableFront #allPage").html(allPageNum);
            var options = {
                size: "normal",
                currentPage: page,
                totalPages: allPageNum,
                numberOfPages: 10,
                onPageClicked: function (e, originalEvent, type, page) {
                    pageFrontload(page, pageSize)
                }
            }
            if (data.count) {//否则返回0条时报错
                $("#tableFront #page_div").bootstrapPaginator(options);
            }
        }

        function pageNextContent(data) {
            $("#tableNext #page_div").empty();
            var allPageNum = Math.ceil(data.count / data.pageSize);
            var page = data.pageNo;
            $("#tableNext #pageNow").html(page);
            $("#tableNext #allNum").html(data.count);
            $("#tableNext #allPage").html(allPageNum);
            var options = {
                size: "normal",
                currentPage: page,
                totalPages: allPageNum,
                numberOfPages: 10,
                onPageClicked: function (e, originalEvent, type, page) {
                    pageNextload(page, pageSize)
                }
            }
            if (data.count) {//否则返回0条时报错
                $("#tableNext #page_div").bootstrapPaginator(options);
            }
        }

        function pageFrontload(n, s) {
            $("#tableFront .page-box").css("display", "none");
            $("#tableFront .page-null").css("display", "none");
            $("#tableFront #page_div").css("display", "none");
            $("#tableFront").append("<div class='spinner loading'><div class='rect1'></div><div class='rect2'></div><div class='rect3'></div><div class='rect4'></div><div class='rect5'></div></div>");
            //删除旧tbody
            var contentTableSub = document.getElementById("frontTable");
            var oldTbody = document.getElementById("frontTbody");
            if (oldTbody != null) {
                contentTableSub.removeChild(oldTbody);
            }
            //添加新tbody
            $.ajax({
                headers: {
                    "token": localStorage.getItem("token"),
                },
                url: APIHost + GetFrontList,
                type: 'Post',
                async: true, //或false,是否异步
                data: {
                    pageNo: n,
                    pageSize: s,
                    spaceName: $("#spaceName").val(),
                    profCode: $("#profFrontCode").val(),
                    classCode: $("#classFrontCode").val(),
                    deviceName: $("#deviceName").val(),
                    linkageCode: paramId,
                    spaceCode: $("#spaceCode").val()
                },
                //timeout : 5000,
                dataType: 'json',
                success: function (res) {
                    $('#tableFront .loading').remove();
                    if (res.code === 1000) {
                        pageFrontContent(res.data);
                        if (res.data.list == '') {
                            $("#tableFront .page-null").css("display", "block");
                            $("#tableFront .page-box").css("display", "none");
                        } else {
                            $("#tableFront .page-null").css("display", "none");
                            $("#tableFront .page-box").css("display", "block");
                            $("#tableFront #page_div").css("display", "block");
                            var newTbody = document.createElement("tbody");
                            newTbody.setAttribute("id", "frontTbody");
                            var list = res.data.list;
                            for (var i = 0; i < list.length; i++) {
                                var entity = list[i];
                                var tr = document.createElement("tr");
                                //选择框
                                var td0 = document.createElement("td");
                                td0.innerHTML = "<input type='checkbox' name='frontBox' data-code='" + list[i].classCode + "' value='" + list[i].id + "'>";
                                tr.appendChild(td0);
                                //序号
                                var td1 = document.createElement("td");
                                td1.innerHTML = i + 1;
                                td1.className = "order_number";
                                tr.appendChild(td1);
                                //空间名称引用节点类型的数据的名称//联动名称//是否启用//说明
                                var properties = new Array("spaceName", "profName", "deviceName", "deviceCode", "status");
                                for (var j = 0; j < properties.length; j++) {
                                    var p0 = properties[j];
                                    var td = document.createElement("td");
                                    if (p0 == "status") {
                                        if (entity[p0] == "Y") {
                                            td.innerHTML = "已设置参数";
                                        } else if (entity[p0] == "N") {
                                            td.innerHTML = "未设置参数";
                                        }
                                    } else {
                                        td.innerHTML = entity[p0];
                                    }
                                    tr.appendChild(td);
                                }
                                var linkageCode = entity["linkageCode"];
                                var id = entity["id"];
                                var td2 = document.createElement("td");
                                if (status == "Y") {
                                    td2.innerHTML = '<span itemId="' + id + '" data-code="' + linkageCode + '" onclick = \"scanItemClick(this);\" type="button">'
                                        + '查看参数</span>';
                                } else {
                                    td2.innerHTML = '<span itemId="' + id + '" data-code="' + linkageCode + '" onclick = \"scanItemClick(this);\" type="button">'
                                        + '查看参数</span>'
                                        + '<span itemId="' + id + '" data-code="front" onclick = "reMoveItem(this)" type="button" >'
                                        + '删除</span>';
                                }
                                tr.appendChild(td2);
                                newTbody.appendChild(tr);
                            }
                            contentTableSub.appendChild(newTbody);
                            //table下每一行tr选中高亮
                            inputCheck();
                            handelBtn();

                        }
                    } else if (res.code === 1003) {
                        //没有登录状态
                        $.jBox.alert('您没有登录状态，请先登录', '提示', {
                            closed: function () {
                                window.parent.location.href = APIHost + "/sys/sysLogin.html";
                            }
                        });
                    } else if (res.code === 1002) {
                        //发生异常
                        $.jBox.alert(res.msg);
                    } else if (res.code === 1004) {
                        //结果为空
                        $.jBox.alert(res.msg);
                    }
                },
                error: function () {
                    $('#loading').remove();
                    $.jBox.alert("服务器代码发生异常,请联系管理员!", '提示');

                }
            })
        }

        //修改
        function editItemClick(index) {
            editItem(index, 'itemId', 'ruag/ruagLinkageDeviceAddForm', 'myModalFront', 'Iframe', 410, 600);
        }

        scanItemClick = function (index) {
            //调用公共方法，弹出窗口
            editItem(index, 'itemId', 'ruag/ruagLinkParamsShow', 'myModalFront', 'Iframe', 410, 600);
        }

        // 操作删除按钮
        function reMoveItem(i) {
            $(".checked_size").find("input").prop("checked", false);
            $(i).parents("td").siblings(".checked_size").find("input").prop("checked", true);
            $(i).parents("tr").children().css("cssText", "background:#F9F9F9 !important");
            $(i).parents("tr").siblings().children().css("cssText", "background:#fff !important");
            var flag = $(i).attr("data-code");
            var id = $(i).attr("itemId");
            $.jBox.confirm("确定删除吗?", "提示", function (v, h, f) {
                if (v == 'ok') {
                    deletebatchProcess(id, flag);
                    $(i).parents("td").siblings(".checked_size").find("input").prop("checked", false);

                }
            })
        }

        function deleteItem(flag) {
            var chckBox;
            if (flag == "front") {
                chckBox = document.getElementsByName("frontBox");
            } else {
                chckBox = document.getElementsByName("nextBox");
            }
            var num = chckBox.length;
            var ids = "";
            for (var index = 0; index < num; index++) {
                if (chckBox[index].checked) {
                    ids += chckBox[index].value + ",";
                }
            }
            if (ids != "") {
                $.jBox.confirm("确定删除吗?", "提示", function (v, h, f) {
                    if (v == 'ok') {
                        //batchProcess(ids);
                        deletebatchProcess(ids, flag);
                        //pageload();
                    }
                })
            } else {
                $.jBox.alert("请选择要删除的对象！", "提示")
            }
        }

        function deletebatchProcess(ids, flag) {
            var deleteUrl;
            if (flag == "front") {
                deleteUrl = DeleteFrontList;
            } else {
                deleteUrl = DeleteNextList;
            }
            $.ajax({
                headers: {
                    "token": localStorage.getItem("token"),
                },
                url: APIHost + deleteUrl,
                type: 'POST',
                async: false, //或false,是否异步
                data: {
                    "ids": ids
                },
                timeout: 5000,
                dataType: 'json',
                success: function (res) {
                    if (res.code === 1000) {
                        if (res.data.msg == "success") {
                            $.jBox.alert('删除成功', '提示', {
                                closed: function () {
                                    pageFrontload();
                                    pageNextload();
                                }
                            });
                        } else {
                            $.jBox.alert("删除失败", "提示");
                        }
                    } else if (res.code === 1002) {
                        //发生异常
                        $.jBox.alert(res.msg);
                    } else if (res.code === 1004) {
                        //结果为空
                        $.jBox.alert(res.msg);
                    }
                },
                error: function () {
                    $.jBox.alert("服务器代码发生异常,请联系管理员!", '提示');

                }
            })
        }

        function insertItem(modalId, url, iframeId, height, width, masterName) {
            var local = "";
            if (masterName == "RUSG_LINKAAGE_FRONT_DEVICE") {
                $('#' + modalId).modal('show');
                $('#' + modalId).css("width", width + "px");
                local = "/ruag/ruag/ruagLinkaageFrontDevice/getByLinkageCode";
            } else {
                var oldTbody = document.getElementById("frontTbody");
                if (oldTbody == null) {
                    $.jBox.alert("请先选择前置设备！", "提示");
                } else {
                    $('#' + modalId).modal('show');
                    $('#' + modalId).css("width", width + "px");
                    local = "/ruag/ruag/ruagLinkaageNextDevice/getNextByLinkageCode";
                }

            }
            var url = APIHost + "/" + url + ".html?url=" + local + "&paramId=" + paramId + "&masterName=" + masterName;
            $("#" + iframeId).attr("src", url);
            $("#" + iframeId).css("height", height + "px");
        }

        //获取跳转地址的参数
        function GetQueryString(name) {
            var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);
            if (r != null) return unescape(r[2]);
            return null;
        }


        //后置
        function pageNextload(n, s) {
            $("#tableNext .page-box").css("display", "none");
            $("#tableNext .page-null").css("display", "none");
            $("#tableNext #page_div").css("display", "none");
            $("#tableNext").append("<div class='spinner loading'><div class='rect1'></div><div class='rect2'></div><div class='rect3'></div><div class='rect4'></div><div class='rect5'></div></div>");
            //删除旧tbody
            var contentTableSub = document.getElementById("nextTable");
            var oldTbody = document.getElementById("nextTbody");
            if (oldTbody != null) {
                contentTableSub.removeChild(oldTbody);
            }
            //添加新tbody
            $.ajax({
                headers: {
                    "token": localStorage.getItem("token"),
                },
                url: APIHost + GetNextList,
                type: 'Post',
                async: false, //或false,是否异步
                data: {
                    pageNo: n,
                    pageSize: s,
                    linkageCode: paramId,
                    spaceName: $("#spaceNameNext").val(),
                    profCode: $("#profNextCode").val(),
                    classCode: $("#classNextCode").val(),
                    deviceName: $("#deviceNameNext").val(),
                    linkageCode: paramId,
                    spaceCodeNext: $("#spaceCodeNext").val()
                },
                timeout: 5000,
                dataType: 'json',
                success: function (res) {
                    $('#tableNext .loading').remove();
                    if (res.code === 1000) {
                        pageNextContent(res.data);
                        var newTbody = document.createElement("tbody");
                        newTbody.setAttribute("id", "nextTbody");
                        var list = res.data.list;
                        if (res.data.list == '') {
                            $("#tableNext .page-null").css("display", "block");
                            $("#tableNext .page-box").css("display", "none");
                        } else {
                            $("#tableNext .page-null").css("display", "none");
                            $("#tableNext .page-box").css("display", "block");
                            $("#tableNext #page_div").css("display", "block");
                            for (var i = 0; i < list.length; i++) {
                                var entity = list[i];
                                var tr = document.createElement("tr");
                                //选择框
                                var td0 = document.createElement("td");
                                td0.innerHTML = "<input type='checkbox' name='nextBox' data-code='" + list[i].classCode + "' value='" + list[i].id + "'>";
                                tr.appendChild(td0);
                                //序号
                                var td1 = document.createElement("td");
                                td1.innerHTML = i + 1;
                                td1.className = "order_number";
                                tr.appendChild(td1);
                                //空间名称引用节点类型的数据的名称//联动名称//是否启用//说明
                                var properties = new Array("spaceName", "profName", "deviceName", "deviceCode", "status");
                                for (var j = 0; j < properties.length; j++) {
                                    var p0 = properties[j];
                                    var td = document.createElement("td");
                                    if (p0 == "status") {
                                        if (entity[p0] == "Y") {
                                            td.innerHTML = "已设置参数";
                                        } else if (entity[p0] == "N") {
                                            td.innerHTML = "未设置参数";
                                        }
                                    } else {
                                        td.innerHTML = entity[p0];
                                    }
                                    tr.appendChild(td);
                                }
                                var linkageCode = entity["linkageCode"];
                                var id = entity["id"];
                                var td2 = document.createElement("td");
                                if (status == "Y") {
                                    td2.innerHTML = '<span itemId="' + id + '" data-code="' + linkageCode + '" onclick = \"scanItemClick(this);\" type="button">'
                                        + '查看参数</span>';
                                } else {
                                    td2.innerHTML = '<span itemId="' + id + '" data-code="' + linkageCode + '" onclick = \"scanItemClick(this);\" type="button">'
                                        + '查看参数</span>'
                                        + '<span itemId="' + id + '" data-code="next" onclick = "reMoveItem(this)" type="button">'
                                        + '删除</span>';
                                }
                                tr.appendChild(td2);
                                newTbody.appendChild(tr);
                            }
                            if (status == "Y") {
                                $(".delete").css("display", "none");
                            } else {
                                $(".delete").css("display", "block");
                            }
                            contentTableSub.appendChild(newTbody);
                            //table下每一行tr选中高亮
                            inputCheck();
                            handelBtn();
                        }

                    } else if (res.code === 1003) {
                        //没有登录状态
                        $.jBox.alert('您没有登录状态，请先登录', '提示', {
                            closed: function () {
                                window.parent.location.href = APIHost + "/sys/sysLogin.html";
                            }
                        });
                    } else if (res.code === 1002) {
                        //发生异常
                        $.jBox.alert(res.msg);
                    } else if (res.code === 1004) {
                        //结果为空
                        $.jBox.alert(res.msg);
                    }
                },
                error: function () {
                    $('#loading').remove();
                    $.jBox.alert("服务器代码发生异常,请联系管理员!", '提示');

                }
            })
        }

        //设置参数
        var LinkDeviceIds = "";
        var masterName = "";
        var classCode = "";
        var deviceClassCode = "";

        function setParam(name) {
            masterName = name;
            var chckBox = "";
            var arr = [];
            if (name == "RUSG_LINKAAGE_NEXT_DEVICE") {
                chckBox = document.getElementsByName("nextBox");
                classCode = "classNextCode";
            } else {
                chckBox = document.getElementsByName("frontBox");
                classCode = "classFrontCode";
            }
            var num = chckBox.length;
            var ids = "";
            for (var index = 0; index < num; index++) {
                if (chckBox[index].checked) {
                    ids += chckBox[index].value + ",";
                    arr.push(chckBox[index].getAttribute("data-code"));
                }
            }
            if (status == "1") {
                $.jBox.alert("该运行策略开启中，不允许对其设备进行设置", "提示");
            } else if (ids == "") {
                $.jBox.alert("请选择想要设置的设备", "提示");
            } else if ($.unique(arr).length != 1) {
                $.jBox.alert("请选择相同设备类型的设备再进行设置", "提示");
            } else {
                LinkDeviceIds = ids;
                if (name == "RUSG_LINKAAGE_NEXT_DEVICE") {
                    parameters("RUSG_LINKAAGE_NEXT_DEVICE", arr[0]);
                } else {
                    parameters("RUSG_LINKAAGE_FRONT_DEVICE", arr[0]);
                }

                /*  $(".left_tree").css("display",""); */
            }

        }

        function parameters(obj, code) {
            console.log(code);
            if (LinkDeviceIds != null) {
                //添加新tbody
                $.ajax({
                    headers: {
                        "token": localStorage.getItem("token"),
                    },
                    url: APIHost + getList,
                    type: 'POST',
                    async: false, //或false,是否异步
                    data: {
                        deviceClassCode: code
                    },
                    timeout: 5000,
                    dataType: 'json',
                    success: function (res) {
                        if (res.code === 1000) {
                            var list = res.data.data;
                            var parameterDiv = document.getElementById("parameterDiv");
                            var str = "";
                            $("#parameterDiv").html("");
                            if (list.length == 0) {
                                $.jBox.alert("该设备所属设备类型没有添加参数！", "提示");
                            } else {
                                $('#myModal').modal({backdrop: 'static', keyboard: false});
                                $("#myModal").modal("show");
                                if (obj == "RUSG_LINKAAGE_FRONT_DEVICE") {
                                    for (var i = 0; i < list.length; i++) {
                                        str += "<div class='addParamDiv control-group'>"
                                            + "<label class='control-label'>设定" + list[i].paramName + "：</label>"
                                            + "<div class='controls'>"
                                            + "<input id='paramCode' name='paramCode'  value='" + list[i].paramCode + "' type='hidden' >"
                                            + "<select id='compareCode' name='compareCode' style='width:50px!important'>"
                                            + "<option value='='>=</option>"
                                            + "<option value='>'>&gt;</option>"
                                            + "<option value='<'>&lt;</option>"
                                            + "</select>"
                                            + "<input id='paramName' name='paramName' class='form-control' style='float:right;width:107px;' type='text' value='' maxlength='100'>"
                                            + "</div>"
                                            + "</div>";
                                    }
                                } else {
                                    for (var i = 0; i < list.length; i++) {
                                        str += "<div class='addParamDiv control-group' style='height:90px'>"
                                            + "<label class='control-label'>设定" + list[i].paramName + "：</label>"
                                            + "<div class='controls'>"
                                            + "<input id='paramCode' name='paramCode'  value='" + list[i].paramCode + "' type='hidden' >"
                                            + "<input id='paramName' name='paramName' class='form-control' style='float:right;width:107px;' type='text' value='' maxlength='100'>"
                                            + "</div>"
                                            + "</div>";
                                    }
                                }
                            }

                            $("#parameterDiv").append(str);
                        } else if (res.code === 1002) {
                            //发生异常
                            $.jBox.alert(res.msg);
                        } else if (res.code === 1004) {
                            //结果为空
                            $.jBox.alert(res.msg);
                        }
                    },
                    error: function () {
                        $.jBox.alert("服务器代码发生异常,请联系管理员!", '提示');

                    }
                })
            }
        }


        function save() {
            $.jBox.confirm("确定提交吗？", "提示", function (v, h, f) {
                if (v == 'ok') {
                    var taskName = "";
                    var content = $(".addParamDiv");
                    $.each(content, function (i, item) {
                        var paramCode = "", paramName = "", compareCode = "";
                        paramCode = $(this).find("input[name='paramCode']").val();
                        paramName = $(this).find("input[name='paramName']").val();
                        compareCode = $(this).find("select[name='compareCode']").val();
                        taskName += paramCode + "," + compareCode + "," + paramName + "]";
                        if ((i + 1) == content.length) {
                            var ajax_option = {
                                headers: {
                                    "token": localStorage.getItem("token"),
                                },
                                url: APIHost + saveUrl,//默认是form action
                                data: {
                                    deviceParams: taskName,
                                    LinkDeviceIds: LinkDeviceIds,
                                    masterName: masterName,
                                    classCode: deviceClassCode,
                                    linkageRuleId: paramId
                                },
                                success: function (res) {
                                    if (res.data.msg == "success") {
                                        $.jBox.alert('保存成功', '提示', {
                                            closed: function () {
                                                window.location.href = APIHost + "/ruag/ruagLinkageDeviceList.html?id=" + paramId;
                                            }
                                        });
                                    } else if (res.data.msg == "haveData") {
                                        $.jBox.alert("参数编码已存在！", "提示");
                                    } else {
                                        $.jBox.alert("保存失败", "提示");
                                    }
                                }
                            }
                            $("#inputForm").ajaxSubmit(ajax_option);
                        }
                    })
                }
            })
        }

        // 关闭弹框
        function closePopUp() {
            $('#myModal').modal("hide");

        }

        //加载所有的专业
        function getProf() {
            $.ajax({
                headers: {
                    "token": localStorage.getItem("token"),
                },
                url: APIHost + '/admin/mdm/deviceprof/mdmDeviceProf/getAllList',
                type: 'POST',
                async: false, //或false,是否异步
                data: {},
                timeout: 5000,
                dataType: 'json',
                success: function (res) {
                    if (res.code === 1000) {
                        //成功返回
                        var data = res.data;
                        $("#profFrontCode").empty();
                        $("#profFrontCode").append("<option value=''></option>");
                        for (var i = 0; i < data.length; i++) {
                            $("#profFrontCode").append("<option value='" + data[i].profCode + "'>" + data[i].profName + "</option>");
                        }
                        $("#profNextCode").empty();
                        $("#profNextCode").append("<option value=''></option>");
                        for (var i = 0; i < data.length; i++) {
                            $("#profNextCode").append("<option value='" + data[i].profCode + "'>" + data[i].profName + "</option>");
                        }
                    } else if (res.code === 1003) {
                        //没有登录状态
                        $.jBox.alert('您没有登录状态，请先登录', '提示', {
                            closed: function () {
                                window.parent.location.href = APIHost + "/sys/sysLogin.html";
                            }
                        });
                    } else if (res.code === 1002) {
                        //发生异常
                        $.jBox.alert(res.msg);
                    } else if (res.code === 1004) {
                        //结果为空
                        $.jBox.alert(res.msg);
                    }
                },
                error: function () {
                    console.log('错误')
                }
            })
        }

        function getNextProf() {
            $.ajax({
                headers: {
                    "token": localStorage.getItem("token"),
                },
                url: APIHost + '/admin/mdm/deviceprof/mdmDeviceProf/getProfByControl',
                type: 'POST',
                async: false, //或false,是否异步
                data: {},
                timeout: 5000,
                dataType: 'json',
                success: function (res) {
                    if (res.code === 1000) {
                        /*//成功返回
                        var data = res.data;
                        $("#profNextCode").empty();
                        $("#profNextCode").append("<option value=''></option>");
                        for (var i = 0; i < data.length; i++) {
                            $("#profNextCode").append("<option value='" + data[i].profCode + "'>" + data[i].profName + "</option>");
                        }*/
                    } else if (res.code === 1003) {
                        //没有登录状态
                        $.jBox.alert('您没有登录状态，请先登录', '提示', {
                            closed: function () {
                                window.parent.location.href = APIHost + "/sys/sysLogin.html";
                            }
                        });
                    } else if (res.code === 1002) {
                        //发生异常
                        $.jBox.alert(res.msg);
                    } else if (res.code === 1004) {
                        //结果为空
                        $.jBox.alert(res.msg);
                    }
                },
                error: function () {
                    console.log('错误')
                }
            })
        }

        //加载对应的设备类型
        function getClass(flag) {
            $.ajax({
                headers: {
                    "token": localStorage.getItem("token"),
                },
                url: APIHost + '/admin/mdm/deviceclass/mdmDeviceClass/getAllList',
                type: 'POST',
                async: false, //或false,是否异步
                data: {
                    profCode: $("#" + flag).val()
                },
                timeout: 5000,
                dataType: 'json',
                success: function (res) {
                    if (res.code === 1000) {
                        //成功返回
                        var data = res.data;
                        if (flag == "profFrontCode") {
                            $("#classFrontCode").empty();
                            $("#classFrontCode").append("<option value=''></option>");
                            for (var i = 0; i < data.length; i++) {
                                $("#classFrontCode").append("<option value='" + data[i].classCode + "'>" + data[i].className + "</option>");
                            }
                        } else {
                            $("#classNextCode").empty();
                            $("#classNextCode").append("<option value=''></option>");
                            for (var i = 0; i < data.length; i++) {
                                $("#classNextCode").append("<option value='" + data[i].classCode + "'>" + data[i].className + "</option>");
                            }
                        }
                    } else if (res.code === 1003) {
                        //没有登录状态
                        $.jBox.alert('您没有登录状态，请先登录', '提示', {
                            closed: function () {
                                window.parent.location.href = APIHost + "/sys/sysLogin.html";
                            }
                        });
                    } else if (res.code === 1002) {
                        //发生异常
                        $.jBox.alert(res.msg);
                    } else if (res.code === 1004) {
                        //结果为空
                        $.jBox.alert(res.msg);
                    }
                },
                error: function () {
                    $.jBox.alert("服务器代码发生异常,请联系管理员!", '提示');

                }
            })
        }

        //专业与设备类型联动事件
        $('#profFrontCode').live('change', function () {
            getClass("profFrontCode");
        });
        $('#profNextCode').live('change', function () {
            getClass("profNextCode");
        });

        function clearUpFront() {
            $("#profFrontCode").select2("val", "");
            $("#classFrontCode").select2("val", "");
            $("input[type=text]").val("");
        }

        function clearUpNext() {
            $("#profNextCode").select2("val", "");
            $("#classNextCode").select2("val", "");
            $("input[type=text]").val("");
        }

        //加载位置树
        function initTree(treeId) {
            var setting = {
                data: {
                    simpleData: {
                        enable: true,
                        idKey: "id",
                        pIdKey: "pId",
                        rootPId: 0
                    }
                },
                callback: {
                    onClick: zTreeOnCheck
                }
            };
            $.ajax({
                headers: {"token": localStorage.getItem("token")},
                url: APIHost + '/admin/mdm/mdmSpaceTree/getSelectSpace',
                type: 'POST',
                async: false,
                data: {
                    "linkCode": paramId
                },
                timeout: 5000,
                dataType: 'json',
                success: function (res) {
                    /* if(res.code === 1000){
                        //成功返回 */
                    /* var data = res.data; */
                    var tree = $.fn.zTree.init($(treeId), setting, res);
                    var treeObj = tree.transformToArray(tree.getNodes());
                    tree.expandAll(false);
                    /* }else if(res.code ===1003){
                        //没有登录状态
                        $.jBox.alert('您没有登录状态，请先登录', '提示',{ closed: function ()
                            { window.parent.location.href= APIHost + "/sys/sysLogin.html"; } });
                    }else if(res.code === 1002){
                        //发生异常
                        $.jBox.alert(res.msg);
                    }else if(res.code === 1004){
                        //结果为空
                        $.jBox.alert(res.msg);
                    } */
                },
                error: function () {
                    $.jBox.alert("服务器代码发生异常,请联系管理员!", '提示');

                }
            });
        }

        showTree = function () {
            if ($(".spaceTree").css("display") == "none") {
                initTree("#spaceTree");
                $("#spaceName").val("");
                names = "";
                codes = "";
                $(".spaceTree").css("display", "block");
                var top = $("#spaceName").position().top + 34;
                var left = $("#spaceName").position().left;
                $(".spaceTree").css({top: top, left: left});
            } else {
                $(".spaceTree").css("display", "none");
            }
        }
        showNextTree = function () {
            if ($(".spaceTreeNext").css("display") == "none") {
                initTree("#spaceTreeNext");
                $("#spaceNameNext").val("");
                names = "";
                codes = "";
                $(".spaceTreeNext").css("display", "block");
                var top = $("#spaceNameNext").position().top + 34;
                var left = $("#spaceNameNext").position().left;
                $(".spaceTreeNext").css({top: top, left: left});
            } else {
                $(".spaceTreeNext").css("display", "none");
            }
        }

        /* $(".spaceTree").mouseenter(function(){
                   $(this).mouseleave(function(event){
                   $(this).hide();
                   $("#positionSearch").val(names);
                   $("#spaceCode").val(codes);
               });
           }); */
        function zTreeOnCheck(event, treeId, treeNode) {
            var treeObj = $.fn.zTree.getZTreeObj("spaceTree");
            var treeObjNext = $.fn.zTree.getZTreeObj("spaceTreeNext");
            if (treeObj != null) {
                var name = treeNode.name;
                $("#spaceName").val(name);
                var childNodes = treeObj.transformToArray(treeNode);
                var nodes = "";
                for (i = 0; i < childNodes.length; i++) {
                    nodes += "'" + childNodes[i].id + "',";
                }
                $("#spaceCode").val(nodes);
                $(".spaceTree").hide();
            }
            if (treeObjNext != null) {
                var name = treeNode.name;
                $("#spaceNameNext").val(name);
                var childNodes = treeObj.transformToArray(treeNode);
                var nodes = "";
                for (i = 0; i < childNodes.length; i++) {
                    nodes += "'" + childNodes[i].id + "',";
                }
                $("#spaceCodeNext").val(nodes);
                $(".spaceTreeNext").hide();
            }
        }
    </script>
</head>
<body>
<div id="tableFront" class="table_fluid">
    <div class="tex00">运行策略模型 / 联动规则维护 / <span>前置设备</span></div>
    <!-- <div class="table_infor">
        <div class="table_title">
            <i class="icon-table"></i><span>前置设备</span>
        </div>
    </div> -->
    <form id="searchForm" class="breadcrumb form-search " method="post">
        <input id="pageNo" name="pageNo" type="hidden" value="1">
        <input id="pageSize" name="pageSize" type="hidden" value="10">
        <input id="orderBy" name="orderBy" type="hidden" value="">
        <input id="spaceCode" name="spaceCode" type="hidden" value="" maxlength="25">
        <ul class="ul-form">
            <li>
                <label>位置：</label>
                <input type="text" id="spaceName" name="spaceName" class="query_input input-medium" readOnly="readonly"
                       style="cursor:pointer" onclick="showTree()" placeholder="请选择">
                <div class="spaceTree"
                     style="display:none;position:absolute; z-index:2; background-color:White;border-bottom: #c3daf9 1px solid; border-left: #c3daf9 1px solid; width: 231px; border-top: #c3daf9 1px solid; border-right: #c3daf9 1px solid;height:200px;overflow: auto">
                    <div id="spaceTree" class="ztree"></div>
                </div>
            </li>
            <li>
                <label>专业：</label>
                <select id="profFrontCode" name="profFrontCode" class="input-medium inputSearch">
                </select>
            </li>
            <li class="clearfix"></li>
            <li>
                <label>设备类型：</label>
                <select id="classFrontCode" name="classFrontCode" class="input-medium inputSearch">
                </select>
            </li>
            <li>
                <label>设备名称：</label>
                <input id="deviceName" name="deviceName" class="query_input query_input" type="text" value=""
                       maxlength="50" onkeypress="if(event.keyCode==13) pageFrontload()">
            </li>
            <li class="btns">
                <button id="btnQuery" class="btn btn-primary btn_middle small_blue" type="button" value="查询"
                        onclick="pageFrontload();">查询
                </button>
                <button id="btnQuery" class="btn btn-primary btn_middle small_clear" type="button" value="清空"
                        onclick="clearUpFront();">清空
                </button>
            </li>
        </ul>
    </form>
    <div class="table_infor">
        <div class="small_btn">
            <button id="btnInsert" class="btn_add" type="button" value="新建"
                    onclick="insertItem('myModalFront','ruag/ruagLinkageDeviceAddForm','Iframe',410,1000,'RUSG_LINKAAGE_FRONT_DEVICE')">
                <i class="icon-plus"></i>
                <span>新增</span>
            </button>
            <button id="btnSetUp" class="btn_add" type="button" value="设置参数"
                    onclick="setParam('RUSG_LINKAAGE_FRONT_DEVICE')">
                <i class="icon-edit"></i>
                <span>设置参数</span>
            </button>
            <button id="btnDeleteF" class="btn_add" type="button" value="删除" onclick="deleteItem('front');">
                <i class="icon-remove"></i>
                <span>刪除</span>
            </button>
        </div>
    </div>
    <script type="text/javascript">
        top.$.jBox.closeTip();
    </script>

    <table id="frontTable" class="table table-striped table-bordered table-condensed">
        <thead>
        <tr>
            <th></th>
            <th>序号</th>
            <th>位置</th>
            <th>专业</th>
            <th>设备名称</th>
            <th>设备编号</th>
            <th>参数状态</th>
            <th>操作</th>
        </tr>
        </thead>
    </table>
</div>
<div id="tableNext" class="table_fluid">
    <div class="tex00">运行策略模型 / 联动规则维护 / <span>联动设备</span></div>
    <!-- <div class="table_infor">
        <div class="table_title">
            <i class="icon-table"></i><span>联动设备</span>
        </div>
    </div> -->
    <form id="searchForm" class="breadcrumb form-search " method="post">
        <input id="pageNo" name="pageNo" type="hidden" value="1">
        <input id="pageSize" name="pageSize" type="hidden" value="10">
        <input id="orderBy" name="orderBy" type="hidden" value="">
        <input id="spaceCodeNext" name="spaceCodeNext" type="hidden" value="" maxlength="25">
        <ul class="ul-form">
            <li>
                <label>位置：</label>
                <input type="text" id="spaceNameNext" name="spaceNameNext" class="query_input input-medium"
                       readOnly="readonly" style="cursor:pointer" onclick="showNextTree()" placeholder="请选择">
                <div class="spaceTreeNext"
                     style="display:none;position:absolute; z-index:2; background-color:White;border-bottom: #c3daf9 1px solid; border-left: #c3daf9 1px solid; width: 231px; border-top: #c3daf9 1px solid; border-right: #c3daf9 1px solid;height:200px;overflow: auto">
                    <div id="spaceTreeNext" class="ztree"></div>
                </div>
            </li>
            <li>
                <label>专业：</label>
                <select id="profNextCode" name="profNextCode" class="input-medium inputSearch">
                </select>
            </li>
            <li class="clearfix"></li>
            <li>
                <label>设备类型：</label>
                <select id="classNextCode" name="classNextCode" class="input-medium inputSearch">
                </select>
            </li>
            <li>
                <label>设备名称：</label><input id="deviceNameNext" name="deviceNameNext" class="query_input input-medium"
                                           type="text" value="" maxlength="50"
                                           onkeypress="if(event.keyCode==13) pageNextload()">
            </li>
            <li class="btns">
                <button id="btnNextQuery" class="btn btn-primary btn_middle small_blue" type="button" value="查询"
                        onclick="pageNextload();">查询
                </button>
                <button id="btnQuery" class="btn btn-primary btn_middle small_clear" type="button" value="清空"
                        onclick="clearUpNext();">清空
                </button>
            </li>
        </ul>
    </form>
    <div class="table_infor">
        <div class="small_btn">
            <button id="btnInsertLink" class="btn_add" type="button" value="新建"
                    onclick="insertItem('myModalFront','ruag/ruagLinkageDeviceAddForm','Iframe',410,1000,'RUSG_LINKAAGE_NEXT_DEVICE')">
                <i class="icon-plus"></i>
                <span>新增</span>
            </button>
            <button id="btnSetUpLink" class="btn_add" type="button" value="设置参数"
                    onclick="setParam('RUSG_LINKAAGE_NEXT_DEVICE')">
                <i class="icon-edit"></i>
                <span>设置参数</span>
            </button>
            <button id="btnDeleteN" class="btn_add" type="button" value="删除" onclick="deleteItem('next');">
                <i class="icon-remove"></i>
                <span>刪除</span>
            </button>
        </div>
    </div>
    <script type="text/javascript">
        top.$.jBox.closeTip();
    </script>
    <table id="nextTable"
           class="table table-striped table-bordered table-condensed">
        <thead>
        <tr>
            <th></th>
            <th>序号</th>
            <th>位置</th>
            <th>专业</th>
            <th>设备名称</th>
            <th>设备编号</th>
            <th>参数状态</th>
            <th>操作</th>
        </tr>
        </thead>
    </table>
</div>

<!-- <iframe src="../ruag/ruagLinkageNextDeviceList.html"></iframe> -->
<!-- Modal -->
<div id="myModalFront" class="modal hide fade" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 id="myModalLabel">选择设备</h4>
    </div>
    <div class="modal-body">
        <iframe id="Iframe"></iframe>
    </div>
</div>
<div id="myModal" class="modal hide fade" tabindex="-1" role="dialog"
     aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 id="myModalLabel">设置参数</h4>
    </div>
    <div class="modal-body" style="max-height: 354px;overflow-y:auto">
        <form id="inputForm" class="form-horizontal" method="post" novalidate="novalidate">
            <script type="text/javascript">top.$.jBox.closeTip();</script>
            <div class="control-group body" id="parameterDiv">
            </div>
            <div class="form-actions">
                <input id="btnCancel" class="btn" type="button" value="关 闭" onclick="closePopUp()">
                <input id="btnSubmit" class="btn btn-primary" type="button" value="保 存" onclick="save()">
            </div>
        </form>
    </div>
</div>
</body>
</html>
